#[derive(Debug)]
pub(crate) struct ReadRequestPdu {
    pub(crate) specification_with_result: Option<bool>,
    pub(crate) variable_access_specification: MmsVariableAccessSpecification,
}

impl ReadRequestPdu {
    pub(crate) fn to_ber(&self) -> BerObject<'_> {
        BerObject::from_header_and_content(
            Header::new(Class::ContextSpecific, true, Tag::from(4), Length::Definite(0)),
            BerObjectContent::Sequence(
                vec![
                    match &self.specification_with_result {
                        Some(specification_with_result) => Some(BerObject::from_header_and_content(
                            Header::new(Class::ContextSpecific, false, Tag::from(0), Length::Definite(0)),
                            BerObjectContent::Boolean(*specification_with_result),
                        )),
                        None => None,
                    },
                    Some(BerObject::from_header_and_content(
                        Header::new(Class::ContextSpecific, true, Tag::from(1), Length::Definite(0)),
                        BerObjectContent::Sequence(vec![self.variable_access_specification.to_ber()]),
                    )),
                ]
                .into_iter()
                .filter_map(|i| i)
                .collect(),
            ),
        )
    }

    pub(crate) fn parse(pdu: &Any<'_>) -> Result<ReadRequestPdu, MmsError> {
        let mut specification_with_result = None;
        let mut variable_access_specification = None;

        match pdu.header.raw_tag() {
            Some(&[164]) => {
                for item in process_constructed_data(pdu.data).map_err(to_mms_error("Failed to parse MMS Request PDU"))? {
                    match item.header.raw_tag() {
                        Some([80]) => specification_with_result = Some(process_mms_boolean_content(&item, "Failed to parse Specification With Result parameter on MMS Request PDU")?),
                        Some([161]) => variable_access_specification = Some(MmsVariableAccessSpecification::parse("Read Request PDU", item.data)?),
                        x => return Err(MmsError::ProtocolError(format!("Unsupported tag in MMS Read Request PDU: {:?}", x))),
                    }
                }
            }
            x => return Err(MmsError::ProtocolError(format!("Expected MMS Read Request PDU to have a tag of 164 a but {:?} was found", x))),
        };

        let variable_access_specification = variable_access_specification.ok_or_else(|| MmsError::ProtocolError("No Variable Access Specification on Request PDU".into()))?;
        Ok(ReadRequestPdu {
            specification_with_result,
            variable_access_specification,
        })
    }
}
